<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Vault Broker - Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-size: 14px;
            overflow-x: hidden;
        }

        .dashboard-header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 10px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo {
            font-size: 1.4em;
            font-weight: 600;
            background: linear-gradient(135deg, #f7931e, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f7931e, #ff6b35);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .user-id {
            font-size: 10px;
            color: #666;
            font-family: monospace;
        }

        .header-buttons {
            display: flex;
            gap: 6px;
        }

        .header-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .profile-btn {
            background: #f7931e;
            color: white;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
        }

        .header-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 10px;
        }

        .blocked-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        .blocked-message.show {
            display: block;
        }

        .blocked-message h3 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .blocked-message p {
            margin-bottom: 10px;
            font-size: 13px;
        }

        .support-link {
            color: #fff;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            text-decoration: none;
            border-radius: 4px;
            display: inline-block;
            transition: background 0.3s ease;
            font-size: 12px;
        }

        .support-link:hover {
            background: rgba(255,255,255,0.3);
        }

        .welcome-section {
            background: white;
            border-radius: 12px;
            padding: 20px 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .welcome-title {
            font-size: 1.6em;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .welcome-subtitle {
            color: #666;
            font-size: 1em;
            line-height: 1.4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .crypto-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .crypto-balance:last-child {
            border-bottom: none;
        }

        .crypto-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .crypto-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 10px;
            flex-shrink: 0;
        }

        .btc { background: #f7931a; }
        .eth { background: #627eea; }
        .ltc { background: #bfbbbb; }
        .bch { background: #4cca5a; }
        .ada { background: #0d1e30; }

        .crypto-name {
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .crypto-amount {
            font-family: monospace;
            font-weight: 600;
            color: #666;
            font-size: 11px;
            text-align: right;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            background: linear-gradient(135deg, #f7931e, #ff6b35);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            position: relative;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 15px rgba(247, 147, 30, 0.3);
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .action-btn.secondary:hover:not(:disabled) {
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }

        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .activity-title {
            font-size: 1.2em;
            color: #333;
        }

        .view-all-link {
            color: #f7931e;
            text-decoration: none;
            font-weight: 500;
            font-size: 13px;
        }

        .view-all-link:hover {
            text-decoration: underline;
        }

        .activity-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.3s ease;
            gap: 10px;
        }

        .activity-item:hover {
            background: #f9f9f9;
        }

        .activity-info {
            flex: 1;
            min-width: 0;
        }

        .activity-type {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .activity-details {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
            word-break: break-all;
        }

        .activity-status {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .no-activity {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }

        .no-activity-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .no-activity h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .no-activity p {
            font-size: 13px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 10px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-30px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.3em;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 500;
            font-size: 13px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #f7931e;
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 4px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f7931e, #ff6b35);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(247, 147, 30, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Profile Styles */
        .profile-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .profile-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .profile-info h4 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #333;
        }

        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
            gap: 10px;
        }

        .profile-field:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .profile-label {
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            flex-shrink: 0;
        }

        .profile-value {
            color: #6c757d;
            font-family: monospace;
            font-size: 11px;
            text-align: right;
            word-break: break-all;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            padding: 12px 15px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            font-size: 13px;
            max-width: none;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.success {
            background: #27ae60;
        }

        .toast.error {
            background: #e74c3c;
        }

        .toast.warning {
            background: #f39c12;
        }

        /* Preloader */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .preloader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #f7931e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .preloader-text {
            color: white;
            font-size: 14px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Account info styling for better mobile display */
        .account-info-content {
            padding: 15px 0;
        }

        .account-info-item {
            margin-bottom: 12px;
        }

        .account-info-label {
            font-weight: 600;
            color: #333;
            display: block;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .account-info-value {
            color: #666;
            font-size: 13px;
            display: block;
        }

        .account-status-active {
            color: #27ae60 !important;
            font-weight: 600;
        }

        .account-status-blocked {
            color: #e74c3c !important;
            font-weight: 600;
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 480px) {
            body {
                font-size: 13px;
            }

            .header-content {
                padding: 8px;
                min-height: 50px;
            }

            .logo {
                font-size: 1.2em;
            }

            .user-details {
                display: none;
            }

            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .header-btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .dashboard-container {
                padding: 12px 8px;
            }

            .welcome-section {
                padding: 15px 12px;
            }

            .welcome-title {
                font-size: 1.4em;
            }

            .welcome-subtitle {
                font-size: 14px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card h3 {
                font-size: 16px;
            }

            .crypto-name {
                font-size: 12px;
            }

            .crypto-amount {
                font-size: 10px;
            }

            .crypto-icon {
                width: 18px;
                height: 18px;
                font-size: 9px;
            }

            .action-btn {
                padding: 10px 12px;
                font-size: 13px;
            }

            .modal {
                padding: 15px;
                margin: 5px;
            }

            .modal-title {
                font-size: 1.2em;
            }

            .form-input, .form-select, .form-textarea {
                padding: 8px;
                font-size: 13px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .activity-item {
                padding: 10px;
            }

            .activity-type {
                font-size: 12px;
            }

            .activity-details {
                font-size: 10px;
            }

            .activity-status {
                font-size: 9px;
                padding: 2px 4px;
            }

            .profile-field {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .profile-value {
                text-align: left;
            }

            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                font-size: 12px;
                padding: 10px 12px;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 769px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .profile-section {
                grid-template-columns: repeat(2, 1fr);
            }

            .toast {
                right: 20px;
                left: auto;
                max-width: 400px;
            }
        }

        @media (min-width: 1024px) {
            .action-buttons {
                grid-template-columns: repeat(4, 1fr);
            }

            .dashboard-container {
                padding: 25px 15px;
            }

            .welcome-section {
                padding: 25px 20px;
            }

            .stat-card {
                padding: 20px;
            }
        }

        /* Fix for horizontal scrolling */
        html, body {
            overflow-x: hidden;
        }

        .dashboard-container {
            width: 100%;
            max-width: 100vw;
        }

        /* Ensure all content stays within viewport */
        * {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader" id="preloader">
        <div class="loader"></div>
        <div class="preloader-text">Loading Dashboard...</div>
    </div>

    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo">Crypto Vault</div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">-</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-id" id="userIdDisplay">Loading...</div>
                </div>
                <div class="header-buttons">
                    <button class="header-btn profile-btn" onclick="showProfile()">Profile</button>
                    <button class="header-btn logout-btn" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Blocked User Message -->
        <div class="blocked-message" id="blockedMessage">
            <h3>Account Suspended</h3>
            <p>Your account has been temporarily suspended by the administrator.</p>
            <p>All trading activities have been disabled.</p>
            <a href="#" class="support-link" onclick="contactSupport()">Contact Customer Support</a>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section">
            <h1 class="welcome-title">Welcome back, <span id="welcomeName">Trader</span>!</h1>
            <p class="welcome-subtitle">Manage your cryptocurrency portfolio and start trading</p>
        </section>

        <!-- Portfolio Stats -->
        <section class="stats-grid">
            <div class="stat-card">
                <h3>Portfolio Balance</h3>
                <div id="portfolioBalances">
                    <div class="crypto-balance">
                        <div class="crypto-info">
                            <div class="crypto-icon btc">‚Çø</div>
                            <span class="crypto-name">Bitcoin (BTC)</span>
                        </div>
                        <span class="crypto-amount" id="btcBalance">0.00000000 BTC</span>
                    </div>
                    <div class="crypto-balance">
                        <div class="crypto-info">
                            <div class="crypto-icon eth">Œû</div>
                            <span class="crypto-name">Ethereum (ETH)</span>
                        </div>
                        <span class="crypto-amount" id="ethBalance">0.00000000 ETH</span>
                    </div>
                    <div class="crypto-balance">
                        <div class="crypto-info">
                            <div class="crypto-icon ltc">≈Å</div>
                            <span class="crypto-name">Litecoin (LTC)</span>
                        </div>
                        <span class="crypto-amount" id="ltcBalance">0.00000000 LTC</span>
                    </div>
                    <div class="crypto-balance">
                        <div class="crypto-info">
                            <div class="crypto-icon bch">‚Çø</div>
                            <span class="crypto-name">Bitcoin Cash (BCH)</span>
                        </div>
                        <span class="crypto-amount" id="bchBalance">0.00000000 BCH</span>
                    </div>
                    <div class="crypto-balance">
                        <div class="crypto-info">
                            <div class="crypto-icon ada">‚Ç≥</div>
                            <span class="crypto-name">Cardano (ADA)</span>
                        </div>
                        <span class="crypto-amount" id="adaBalance">0.00000000 ADA</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>Account Information</h3>
                <div class="account-info-content">
                    <div class="account-info-item">
                        <span class="account-info-label">User ID:</span>
                        <span class="account-info-value" id="accountUserId">Loading...</span>
                    </div>
                    <div class="account-info-item">
                        <span class="account-info-label">Account Status:</span>
                        <span class="account-info-value account-status-active" id="accountStatus">Active</span>
                    </div>
                    <div class="account-info-item">
                        <span class="account-info-label">Member Since:</span>
                        <span class="account-info-value" id="memberSince">Loading...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Action Buttons -->
        <section class="action-buttons" id="actionButtons">
            <button class="action-btn" onclick="showDepositModal()">
                Deposit Crypto
            </button>
            <button class="action-btn" onclick="showWithdrawModal()">
                Withdraw Crypto
            </button>
            <button class="action-btn secondary" onclick="showTransferModal()">
                Transfer to User
            </button>
            <button class="action-btn secondary" onclick="showTradeModal()">
                Start Trading
            </button>
        </section>

        <!-- Recent Activity -->
        <section class="recent-activity">
            <div class="activity-header">
                <h2 class="activity-title">Recent Activity</h2>
                <a href="#" class="view-all-link" onclick="showTransactionHistory()">View All</a>
            </div>
            <div class="activity-list" id="activityList">
                <div class="no-activity" id="noActivity">
                    <div class="no-activity-icon">üìä</div>
                    <h3>No Recent Activity</h3>
                    <p>Your transaction history will appear here once you start trading.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Modals will be added here -->
    <div id="modalContainer"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9K9Z26ogXI5Zi9T4lVpo19bhuwa-jdl8",
            authDomain: "calivra-52bae.firebaseapp.com",
            projectId: "calivra-52bae",
            storageBucket: "calivra-52bae.firebasestorage.app",
            messagingSenderId: "983246623613",
            appId: "1:983246623613:web:62fd33f6b9ef8b094c3214"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let currentAuthUid = null;
        let currentUserId = null; // Custom user ID
        let isBlocked = false;

        // Show toast notification
        function showToast(message, type) {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Update crypto balance display
        function updateBalanceDisplay(crypto, balance) {
            const element = document.getElementById(`${crypto.toLowerCase()}Balance`);
            if (element) {
                element.textContent = `${balance.toFixed(8)} ${crypto.toUpperCase()}`;
            }
        }

        // Check if user is blocked
        function checkUserStatus() {
            if (currentUser && currentUser.status === 'blocked') {
                isBlocked = true;
                document.getElementById('blockedMessage').classList.add('show');
                document.getElementById('accountStatus').textContent = 'Suspended';
                document.getElementById('accountStatus').className = 'account-info-value account-status-blocked';
                
                // Disable action buttons
                const actionButtons = document.querySelectorAll('.action-btn');
                actionButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                });
                
                return true;
            }
            return false;
        }

        // Contact support function
        function contactSupport() {
            showToast('Redirecting to customer support...', 'success');
            setTimeout(() => {
                window.open('mailto:support@cryptovaultbroker.com?subject=Account Suspension Appeal', '_blank');
            }, 1000);
        }

        // Load user transactions and recent activity
        async function loadRecentActivity() {
            if (!currentAuthUid) return;

            try {
                const transactionsSnapshot = await database.ref(`transactions`).orderByChild('authUid').equalTo(currentAuthUid).limitToLast(5).once('value');
                const activityList = document.getElementById('activityList');
                const noActivity = document.getElementById('noActivity');

                if (transactionsSnapshot.exists()) {
                    const transactions = Object.values(transactionsSnapshot.val()).reverse();
                    noActivity.style.display = 'none';
                    
                    activityList.innerHTML = transactions.map(tx => `
                        <div class="activity-item">
                            <div class="activity-info">
                                <div class="activity-type">${tx.type.toUpperCase()}: ${tx.amount} ${tx.crypto}</div>
                                <div class="activity-details">
                                    ${tx.type === 'transfer' ? `To: ${tx.recipientId}` : ''}
                                    ${tx.address ? `Address: ${tx.address.substring(0, 20)}...` : ''}
                                    <br>
                                    ${new Date(tx.timestamp).toLocaleString()}
                                </div>
                            </div>
                            <span class="activity-status status-${tx.status}">${tx.status}</span>
                        </div>
                    `).join('');
                } else {
                    noActivity.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        // Load user data and update dashboard
        async function loadUserData() {
            if (!currentAuthUid) {
                showToast('Session expired. Please login again.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            try {
                // Load user data using Firebase Auth UID
                const userSnapshot = await database.ref(`users/${currentAuthUid}`).once('value');
                
                if (!userSnapshot.exists()) {
                    throw new Error('User data not found');
                }

                currentUser = userSnapshot.val();
                currentUserId = currentUser.userId; // Get custom user ID from stored data
                
                // Check if user is blocked
                if (checkUserStatus()) {
                    return;
                }
                
                // Update UI with user data
                const firstName = currentUser.firstName || 'Trader';
                const lastName = currentUser.lastName || '';
                const fullName = `${firstName} ${lastName}`.trim();
                
                // Update header
                document.getElementById('userName').textContent = fullName;
                document.getElementById('userIdDisplay').textContent = currentUserId || currentAuthUid;
                document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();
                
                // Update welcome section
                document.getElementById('welcomeName').textContent = firstName;
                
                // Update account info
                document.getElementById('accountUserId').textContent = currentUserId || currentAuthUid;
                document.getElementById('memberSince').textContent = formatDate(currentUser.createdAt);
                
                // Update crypto balances
                if (currentUser.balances) {
                    updateBalanceDisplay('BTC', currentUser.balances.BTC || 0);
                    updateBalanceDisplay('ETH', currentUser.balances.ETH || 0);
                    updateBalanceDisplay('LTC', currentUser.balances.LTC || 0);
                    updateBalanceDisplay('BCH', currentUser.balances.BCH || 0);
                    updateBalanceDisplay('ADA', currentUser.balances.ADA || 0);
                }

                // Load recent activity
                await loadRecentActivity();

                console.log('User data loaded successfully:', {
                    authUid: currentAuthUid,
                    userId: currentUserId,
                    name: fullName,
                    balances: currentUser.balances,
                    status: currentUser.status
                });

            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading user data. Please try again.', 'error');
            }
        }

        // Modal functions
        function createModal(title, content, actions = '') {
            return `
                <div class="modal-overlay active" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-content">
                            ${content}
                        </div>
                        ${actions}
                    </div>
                </div>
            `;
        }

        function showModal(modalHTML) {
            document.getElementById('modalContainer').innerHTML = modalHTML;
        }

        function closeModal(event) {
            if (event && event.target.classList.contains('modal')) return;
            document.getElementById('modalContainer').innerHTML = '';
        }

        // Check if user is blocked before action
        function checkBlockedStatus() {
            if (isBlocked || (currentUser && currentUser.status === 'blocked')) {
                showToast('Account suspended. Please contact customer support.', 'error');
                return true;
            }
            return false;
        }

        // Deposit Modal
        function showDepositModal() {
            if (checkBlockedStatus()) return;

            const content = `
                <form id="depositForm">
                    <div class="form-group">
                        <label class="form-label">Select Cryptocurrency *</label>
                        <select class="form-select" id="depositCrypto" required>
                            <option value="">Choose cryptocurrency</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="LTC">Litecoin (LTC)</option>
                            <option value="BCH">Bitcoin Cash (BCH)</option>
                            <option value="ADA">Cardano (ADA)</option>
                        </select>
                        <div class="error-message" id="depositCryptoError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Amount *</label>
                        <input type="number" class="form-input" id="depositAmount" placeholder="0.00000000" step="0.00000001" min="0.00000001" required>
                        <div class="error-message" id="depositAmountError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">From Wallet Address *</label>
                        <input type="text" class="form-input" id="depositAddress" placeholder="Enter your external wallet address" required>
                        <div class="error-message" id="depositAddressError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Transaction Hash (Optional)</label>
                        <input type="text" class="form-input" id="depositTxHash" placeholder="Enter transaction hash for verification">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Trading PIN *</label>
                        <input type="password" class="form-input" id="depositPin" placeholder="Enter your 4-digit PIN" maxlength="4" required>
                        <div class="error-message" id="depositPinError"></div>
                    </div>

                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin: 15px 0;">
                        <strong>Important:</strong> Your deposit will be pending until verified by our admin team. This usually takes 24-48 hours.
                    </div>
                </form>
            `;

            const actions = `
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="submitDeposit()">Submit Deposit</button>
                </div>
            `;

            showModal(createModal('Deposit Cryptocurrency', content, actions));
        }

        // Submit deposit (NO ADDRESS VALIDATION)
        async function submitDeposit() {
            if (checkBlockedStatus()) return;

            const crypto = document.getElementById('depositCrypto').value;
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const address = document.getElementById('depositAddress').value.trim();
            const txHash = document.getElementById('depositTxHash').value.trim();
            const pin = document.getElementById('depositPin').value;

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

            let isValid = true;

            if (!crypto) {
                document.getElementById('depositCryptoError').textContent = 'Please select a cryptocurrency';
                isValid = false;
            }

            if (!amount || amount <= 0) {
                document.getElementById('depositAmountError').textContent = 'Please enter a valid amount';
                isValid = false;
            }

            if (!address) {
                document.getElementById('depositAddressError').textContent = 'Please enter a wallet address';
                isValid = false;
            }

            if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                document.getElementById('depositPinError').textContent = 'Please enter a valid 4-digit PIN';
                isValid = false;
            }

            if (!isValid) return;

            // Verify PIN
            if (pin !== currentUser.pin) {
                document.getElementById('depositPinError').textContent = 'Invalid PIN';
                return;
            }

            try {
                const transactionId = `dep_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const transactionData = {
                    id: transactionId,
                    authUid: currentAuthUid,
                    userId: currentUserId,
                    type: 'deposit',
                    crypto: crypto,
                    amount: amount,
                    address: address,
                    txHash: txHash || null,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    adminNotes: null
                };

                await database.ref(`transactions/${transactionId}`).set(transactionData);
                
                showToast('Deposit request submitted successfully! Awaiting admin approval.', 'success');
                closeModal();
                await loadRecentActivity();

            } catch (error) {
                console.error('Error submitting deposit:', error);
                showToast('Error submitting deposit. Please try again.', 'error');
            }
        }

        // Withdraw Modal
        function showWithdrawModal() {
            if (checkBlockedStatus()) return;

            const content = `
                <form id="withdrawForm">
                    <div class="form-group">
                        <label class="form-label">Select Cryptocurrency *</label>
                        <select class="form-select" id="withdrawCrypto" required onchange="updateAvailableBalance()">
                            <option value="">Choose cryptocurrency</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="LTC">Litecoin (LTC)</option>
                            <option value="BCH">Bitcoin Cash (BCH)</option>
                            <option value="ADA">Cardano (ADA)</option>
                        </select>
                        <div class="error-message" id="withdrawCryptoError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Available Balance</label>
                        <input type="text" class="form-input" id="availableBalance" readonly placeholder="Select cryptocurrency first">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Amount to Withdraw *</label>
                        <input type="number" class="form-input" id="withdrawAmount" placeholder="0.00000000" step="0.00000001" min="0.00000001" required>
                        <div class="error-message" id="withdrawAmountError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Destination Wallet Address *</label>
                        <input type="text" class="form-input" id="withdrawAddress" placeholder="Enter destination wallet address" required>
                        <div class="error-message" id="withdrawAddressError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Trading PIN *</label>
                        <input type="password" class="form-input" id="withdrawPin" placeholder="Enter your 4-digit PIN" maxlength="4" required>
                        <div class="error-message" id="withdrawPinError"></div>
                    </div>

                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; margin: 15px 0;">
                        <strong>Warning:</strong> Ensure the wallet address is correct. Transactions cannot be reversed once approved by admin.
                    </div>
                </form>
            `;

            const actions = `
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="submitWithdraw()">Submit Withdrawal</button>
                </div>
            `;

            showModal(createModal('Withdraw Cryptocurrency', content, actions));
        }

        // Update available balance in withdraw modal
        function updateAvailableBalance() {
            const crypto = document.getElementById('withdrawCrypto').value;
            const balanceField = document.getElementById('availableBalance');
            
            if (crypto && currentUser && currentUser.balances) {
                const balance = currentUser.balances[crypto] || 0;
                balanceField.value = `${balance.toFixed(8)} ${crypto}`;
            } else {
                balanceField.value = '';
            }
        }

        // Submit withdrawal (NO ADDRESS VALIDATION)
        async function submitWithdraw() {
            if (checkBlockedStatus()) return;

            const crypto = document.getElementById('withdrawCrypto').value;
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value.trim();
            const pin = document.getElementById('withdrawPin').value;

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

            let isValid = true;

            if (!crypto) {
                document.getElementById('withdrawCryptoError').textContent = 'Please select a cryptocurrency';
                isValid = false;
            }

            if (!amount || amount <= 0) {
                document.getElementById('withdrawAmountError').textContent = 'Please enter a valid amount';
                isValid = false;
            }

            if (!address) {
                document.getElementById('withdrawAddressError').textContent = 'Please enter a wallet address';
                isValid = false;
            }

            if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                document.getElementById('withdrawPinError').textContent = 'Please enter a valid 4-digit PIN';
                isValid = false;
            }

            // Check if user has sufficient balance
            if (crypto && currentUser && currentUser.balances) {
                const availableBalance = currentUser.balances[crypto] || 0;
                if (amount > availableBalance) {
                    document.getElementById('withdrawAmountError').textContent = 'Insufficient balance';
                    isValid = false;
                }
            }

            if (!isValid) return;

            // Verify PIN
            if (pin !== currentUser.pin) {
                document.getElementById('withdrawPinError').textContent = 'Invalid PIN';
                return;
            }

            try {
                const transactionId = `wit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const transactionData = {
                    id: transactionId,
                    authUid: currentAuthUid,
                    userId: currentUserId,
                    type: 'withdraw',
                    crypto: crypto,
                    amount: amount,
                    address: address,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    adminNotes: null
                };

                await database.ref(`transactions/${transactionId}`).set(transactionData);
                
                showToast('Withdrawal request submitted successfully! Awaiting admin approval.', 'success');
                closeModal();
                await loadRecentActivity();

            } catch (error) {
                console.error('Error submitting withdrawal:', error);
                showToast('Error submitting withdrawal. Please try again.', 'error');
            }
        }

        // Transfer Modal
        function showTransferModal() {
            if (checkBlockedStatus()) return;

            const content = `
                <form id="transferForm">
                    <div class="form-group">
                        <label class="form-label">Recipient User ID *</label>
                        <input type="text" class="form-input" id="recipientId" placeholder="Enter recipient's user ID" required>
                        <div class="error-message" id="recipientIdError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Select Cryptocurrency *</label>
                        <select class="form-select" id="transferCrypto" required onchange="updateTransferBalance()">
                            <option value="">Choose cryptocurrency</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="LTC">Litecoin (LTC)</option>
                            <option value="BCH">Bitcoin Cash (BCH)</option>
                            <option value="ADA">Cardano (ADA)</option>
                        </select>
                        <div class="error-message" id="transferCryptoError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Available Balance</label>
                        <input type="text" class="form-input" id="transferAvailableBalance" readonly placeholder="Select cryptocurrency first">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Amount to Transfer *</label>
                        <input type="number" class="form-input" id="transferAmount" placeholder="0.00000000" step="0.00000001" min="0.00000001" required>
                        <div class="error-message" id="transferAmountError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Transfer Note (Optional)</label>
                        <textarea class="form-textarea" id="transferNote" placeholder="Add a note for the recipient"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Trading PIN *</label>
                        <input type="password" class="form-input" id="transferPin" placeholder="Enter your 4-digit PIN" maxlength="4" required>
                        <div class="error-message" id="transferPinError"></div>
                    </div>

                    <div style="background: #d1ecf1; border: 1px solid #b8daff; border-radius: 5px; padding: 15px; margin: 15px 0;">
                        <strong>Note:</strong> Transfers require admin approval and may take 24-48 hours to complete.
                    </div>
                </form>
            `;

            const actions = `
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="submitTransfer()">Submit Transfer</button>
                </div>
            `;

            showModal(createModal('Transfer to User', content, actions));
        }

        // Update available balance in transfer modal
        function updateTransferBalance() {
            const crypto = document.getElementById('transferCrypto').value;
            const balanceField = document.getElementById('transferAvailableBalance');
            
            if (crypto && currentUser && currentUser.balances) {
                const balance = currentUser.balances[crypto] || 0;
                balanceField.value = `${balance.toFixed(8)} ${crypto}`;
            } else {
                balanceField.value = '';
            }
        }

        // Submit transfer (NO RECIPIENT VALIDATION)
        async function submitTransfer() {
            if (checkBlockedStatus()) return;

            const recipientId = document.getElementById('recipientId').value.trim();
            const crypto = document.getElementById('transferCrypto').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const note = document.getElementById('transferNote').value.trim();
            const pin = document.getElementById('transferPin').value;

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

            let isValid = true;

            if (!recipientId) {
                document.getElementById('recipientIdError').textContent = 'Please enter recipient User ID';
                isValid = false;
            }

            if (recipientId === currentUserId) {
                document.getElementById('recipientIdError').textContent = 'Cannot transfer to yourself';
                isValid = false;
            }

            if (!crypto) {
                document.getElementById('transferCryptoError').textContent = 'Please select a cryptocurrency';
                isValid = false;
            }

            if (!amount || amount <= 0) {
                document.getElementById('transferAmountError').textContent = 'Please enter a valid amount';
                isValid = false;
            }

            if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                document.getElementById('transferPinError').textContent = 'Please enter a valid 4-digit PIN';
                isValid = false;
            }

            // Check if user has sufficient balance
            if (crypto && currentUser && currentUser.balances) {
                const availableBalance = currentUser.balances[crypto] || 0;
                if (amount > availableBalance) {
                    document.getElementById('transferAmountError').textContent = 'Insufficient balance';
                    isValid = false;
                }
            }

            if (!isValid) return;

            // Verify PIN
            if (pin !== currentUser.pin) {
                document.getElementById('transferPinError').textContent = 'Invalid PIN';
                return;
            }

            try {
                const transactionId = `tra_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const transactionData = {
                    id: transactionId,
                    authUid: currentAuthUid,
                    userId: currentUserId,
                    recipientId: recipientId,
                    type: 'transfer',
                    crypto: crypto,
                    amount: amount,
                    note: note || null,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    adminNotes: null
                };

                await database.ref(`transactions/${transactionId}`).set(transactionData);
                
                showToast('Transfer request submitted successfully! Awaiting admin approval.', 'success');
                closeModal();
                await loadRecentActivity();

            } catch (error) {
                console.error('Error submitting transfer:', error);
                showToast('Error submitting transfer. Please try again.', 'error');
            }
        }

        // Trade Modal (Placeholder)
        function showTradeModal() {
            if (checkBlockedStatus()) return;
            
            const content = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üìà</div>
                    <h3>Trading Platform Coming Soon!</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        Our advanced trading platform is under development and will be available soon.
                    </p>
                    <p style="color: #666;">
                        Features will include:
                    </p>
                    <ul style="text-align: left; margin: 20px 0; color: #666;">
                        <li>Real-time cryptocurrency prices</li>
                        <li>Advanced charting tools</li>
                        <li>Multiple order types</li>
                        <li>Portfolio analysis</li>
                        <li>Risk management tools</li>
                    </ul>
                </div>
            `;

            const actions = `
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal()">Got It</button>
                </div>
            `;

            showModal(createModal('Trading Platform', content, actions));
        }

        // Profile Modal
        function showProfile() {
            if (!currentUser) return;

            const content = `
                <div class="profile-section">
                    <div class="profile-info">
                        <h4 style="margin-bottom: 15px; color: #333;">Personal Information</h4>
                        <div class="profile-field">
                            <span class="profile-label">First Name:</span>
                            <span class="profile-value">${currentUser.firstName || 'N/A'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Last Name:</span>
                            <span class="profile-value">${currentUser.lastName || 'N/A'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Email:</span>
                            <span class="profile-value">${currentUser.email || 'N/A'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Username:</span>
                            <span class="profile-value">${currentUser.username || 'N/A'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Phone:</span>
                            <span class="profile-value">${currentUser.phone || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="profile-info">
                        <h4 style="margin-bottom: 15px; color: #333;">Account Details</h4>
                        <div class="profile-field">
                            <span class="profile-label">User ID:</span>
                            <span class="profile-value">${currentUserId || 'N/A'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Auth UID:</span>
                            <span class="profile-value">${currentAuthUid}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Country:</span>
                            <span class="profile-value">${currentUser.country || 'N/A'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Account Status:</span>
                            <span class="profile-value" style="color: ${currentUser.status === 'active' ? '#27ae60' : '#e74c3c'};">
                                ${currentUser.status ? currentUser.status.toUpperCase() : 'ACTIVE'}
                            </span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Member Since:</span>
                            <span class="profile-value">${formatDate(currentUser.createdAt)}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Last Login:</span>
                            <span class="profile-value">${currentUser.lastLogin ? new Date(currentUser.lastLogin).toLocaleString() : 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;

            const actions = `
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal()">Close</button>
                </div>
            `;

            showModal(createModal('Profile Information', content, actions));
        }

        // Transaction History Modal
        function showTransactionHistory() {
            const content = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üìã</div>
                    <h3>Full Transaction History</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        Complete transaction history feature coming soon!
                    </p>
                    <p style="color: #666;">
                        This will include detailed records of all your:
                    </p>
                    <ul style="text-align: left; margin: 20px 0; color: #666;">
                        <li>Deposits and withdrawals</li>
                        <li>Transfers to/from other users</li>
                        <li>Trading activities</li>
                        <li>Transaction status updates</li>
                        <li>Export functionality</li>
                    </ul>
                </div>
            `;

            const actions = `
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal()">Close</button>
                </div>
            `;

            showModal(createModal('Transaction History', content, actions));
        }

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    // Sign out from Firebase Auth
                    await auth.signOut();
                    
                    // Clear session data
                    sessionStorage.removeItem('currentUserId');
                    sessionStorage.removeItem('currentAuthUid');
                    sessionStorage.removeItem('userEmail');
                    localStorage.removeItem('rememberedUser');
                    
                    // Show logout message
                    showToast('Signing out...', 'success');
                    
                    // Redirect to login page
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                } catch (error) {
                    console.error('Error signing out:', error);
                    showToast('Error signing out. Please try again.', 'error');
                }
            }
        }

        // Check authentication and load dashboard
        async function initializeDashboard() {
            // Check Firebase Auth state
            return new Promise((resolve) => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    unsubscribe(); // Stop listening after first check
                    
                    if (user) {
                        // User is signed in
                        currentAuthUid = user.uid;
                        
                        // Store in session for compatibility
                        sessionStorage.setItem('currentAuthUid', currentAuthUid);
                        sessionStorage.setItem('userEmail', user.email);
                        
                        console.log('Firebase Auth user found:', {
                            uid: user.uid,
                            email: user.email,
                            emailVerified: user.emailVerified
                        });
                        
                        // Load user data from Realtime Database
                        await loadUserData();
                        resolve();
                    } else {
                        // No user signed in, redirect to login
                        showToast('Please login to access your dashboard.', 'error');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        resolve();
                    }
                });
            });
        }

        // Auto-logout on inactivity (30 minutes)
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(async () => {
                await auth.signOut();
                showToast('Session expired due to inactivity.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Reset timer on user activity
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Crypto Vault Broker Dashboard with Firebase Auth Loading...');
            
            // Initialize inactivity timer
            resetInactivityTimer();
            
            try {
                // Initialize dashboard
                await initializeDashboard();
                
                // Hide preloader
                setTimeout(() => {
                    document.getElementById('preloader').classList.add('hidden');
                }, 1000);
                
                console.log('Enhanced Dashboard with Firebase Auth loaded successfully!');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showToast('Error loading dashboard. Please refresh the page.', 'error');
                
                // Hide preloader even on error
                setTimeout(() => {
                    document.getElementById('preloader').classList.add('hidden');
                }, 1000);
            }
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentAuthUid) {
                // Refresh user data when page becomes visible
                loadUserData();
            }
        });

        // Firebase connection monitoring
        database.ref('.info/connected').on('value', (snapshot) => {
            if (!snapshot.val()) {
                showToast('Connection lost. Please check your internet connection.', 'error');
            }
        });

        // Handle browser back/forward navigation
        window.addEventListener('popstate', () => {
            // Prevent going back to login if user is authenticated
            if (currentAuthUid && window.location.pathname.includes('login')) {
                history.pushState(null, null, 'dashboard.html');
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Firebase Auth state change listener for logout detection
        auth.onAuthStateChanged((user) => {
            if (!user && currentAuthUid) {
                // User was signed out
                currentUser = null;
                currentAuthUid = null;
                currentUserId = null;
                
                // Clear session data
                sessionStorage.removeItem('currentUserId');
                sessionStorage.removeItem('currentAuthUid');
                sessionStorage.removeItem('userEmail');
                
                // Redirect to login
                window.location.href = 'login.html';
            }
        });
    </script>

<!-- Begin of Chaport Live Chat code -->
<script type="text/javascript">
(function(w,d,v3){
w.chaportConfig = {
  appId : '68d649a470ebed7cb4395e26',
};

if(w.chaport)return;v3=w.chaport={};v3._q=[];v3._l={};v3.q=function(){v3._q.push(arguments)};v3.on=function(e,fn){if(!v3._l[e])v3._l[e]=[];v3._l[e].push(fn)};var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://app.chaport.com/javascripts/insert.js';var ss=d.getElementsByTagName('script')[0];ss.parentNode.insertBefore(s,ss)})(window, document);
</script>
<!-- End of Chaport Live Chat code -->

</body>
</html>